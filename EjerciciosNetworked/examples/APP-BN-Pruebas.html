<!DOCTYPE html>
<html lang="es">

<head>
    <!-- Libreria de Aframe 1.5.0 -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Libreria de Networked Aframe 0.12.0-->
    <script src="https://unpkg.com/networked-aframe@^0.12.0/dist/networked-aframe.min.js"></script>
    <!-- Libreria de Socket 2.5.0 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.slim.js"></script>
    <!-- Libreria de EasyRTC -->
    <script src="/easyrtc/easyrtc.js"></script>
    <!-- Babia -->
    <script src="https://unpkg.com/aframe-babia-components/dist/aframe-babia-components.min.js"></script>
    <!-- libreria extra -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <!-- Enviorement -->
    <script src="https://unpkg.com/aframe-environment-component@1.3.4/dist/aframe-environment-component.min.js"></script>
    <!-- Image Favicon -->
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <!-- CSSs -->
    <link rel="stylesheet" type="text/css" href="css/styleChat.css">

    <!-- Scripts Componentes/Logica-->

    <script src="js/spawn-in-circle.component.js"></script>

<!-- Scripts Componentes/Logica
    <script src="app-bn-js/schemas.js"></script>
    <script src="app-bn-js/player-info.js"></script>
    <script src="app-bn-js/poster-events.js"></script>
    <script src="app-bn-js/pre-create.js"></script>
    <script src="app-bn-js/create-ui.js"></script>
-->

    <script>

        NAF.schemas.getComponentsOriginal = NAF.schemas.getComponents;
        NAF.schemas.getComponents = (template) => {
          if (!NAF.schemas.hasTemplate('#avatar-man-template')) {
            NAF.schemas.add({
              template: '#avatar-man-template',
              components: [
                'position',
                'rotation',
                'player-info'
              ]
            });
          }

          if (!NAF.schemas.hasTemplate('#box-template')) {
            NAF.schemas.add({
              template: '#box-template',
              components: [
                'position',
                {
                  component: 'material',
                  property: 'color'
                },
                'animation'
              ]
            });
          }

          if (!NAF.schemas.hasTemplate('#icon-create-template')) {
            NAF.schemas.add({
              template: '#icon-create-template',
              components: [
                'position',
                'rotation',
                'animation'
              ]
            });
          }

          if (!NAF.schemas.hasTemplate('#main-row-template')) {
            NAF.schemas.add({
              template: '#main-row-template',
              components: [
                'position',
                'animation',
                'geometry',
                {
                  component: 'material',
                  property: 'color'
                },
                {
                  selector: '.poster-plane',
                  component: 'visible'
                },
              ]
            });
          }

          if (!NAF.schemas.hasTemplate('#row-shield-template')) {
            NAF.schemas.add({
              template: '#create-ui-shield-template',
              components: [
                'position',
                'material',
                'geometry'

              ]
            });
          }


          const components = NAF.schemas.getComponentsOriginal(template);
          return components;
        };

    </script>

  <script>

    AFRAME.registerComponent('player-info', {
      schema: {
        name: { type: 'string', default: 'User-' + Math.round(Math.random() * 1000) },
        message: { type: 'string', default: '' }
      },

      init: function () {
        console.log("################## INIT player-info");
        this.nametag = this.el.querySelector('.nametag');
        this.ownedByLocalUser = this.el.id === 'player';
        if (this.ownedByLocalUser) {
          this.nametagInput = document.getElementById('username-overlay');
          this.nametagInput.value = this.data.name;
        }
      },

      update: function () {
        console.log("################## UPDATE player-info");
        if (this.nametag) {
          this.nametag.setAttribute('value', this.data.name);
        }
      }
    });

    AFRAME.registerComponent('poster-events', {

      init: function () {
        console.log("################## INIT poster-events");
      },

      update: function () {
        console.log("################## UPDATE poster-events");
      },

      events: {
        mouseenter: function (evt) {
          //console.log("################## mouseenter poster-events");
          NAF.utils.takeOwnership(this.el);
          this.el.setAttribute('animation', { 'property': 'scale', 'to': '1.2 1.2 1.2', 'dur': '200' });

        },
        mouseleave: function (evt) {
          //console.log("################## mouseleave poster-events");
          this.el.setAttribute('animation', { 'property': 'scale', 'to': '1 1 1', 'dur': '200' });

        },
        click: function (evt) {
          console.log("################## click poster-events");
          this.el.children[0].setAttribute('visible', 'true');

          document.querySelectorAll('.main-row').forEach(entityValue => {
            if (this.el.children[0] !== entityValue.children[0]) {
              NAF.utils.takeOwnership(entityValue);
              entityValue.children[0].setAttribute('visible', 'false');
            }
          });
        }
      }
    });

    AFRAME.registerComponent('pre-create', {

      init: function () {
        console.log("################## INIT pre-create");
      },

      update: function () {
        console.log("################## UPDATE pre-create");
      },

      events: {
        click: function (evt) {
          console.log("################## click pre-create");
          NAF.utils.takeOwnership(this.el);

          var scene = this.el.sceneEl;
          scene.removeChild(this.el);

          let entityCreate = document.createElement('a-entity');
          entityCreate.setAttribute('networked', {'template': '#create-ui-template', 'networkId': 'createui'});
          entityCreate.setAttribute('create-ui', '');
          scene.appendChild(entityCreate);
        }
      }
    });

    AFRAME.registerComponent('create-ui', {

      init: function () {
        console.log("################## create-ui INIT");
        this.generateInterface();
      },

      update: function () {
        console.log("################## create-ui UPDATE ");
      },


      //Otras Funcionas
      generateInterface: function () {
        console.log("################## create-ui generateInterface  ##################");
        createRow(this);

      },


    });

    let createRow = (self) => {
      console.log("################## create-ui createRow  ##################");
      let i = 1;

      let entityfield = document.createElement('a-entity');
      entityfield.classList.add("main-row");
      entityfield.setAttribute('networked', {'template': '#main-row-template', 'networkId': 'main-row-field' + i});
      entityfield.setAttribute('position', '-3.5 6 -6');
      entityfield.setAttribute('poster-events', '');
      
      let entityChild = document.createElement('a-entity');
      //entityChild.setAttribute('networked', {'template': '#create-ui-shield-template', 'networkId': 'create-ui-shield' + i});
      entityChild.classList.add("poster-plane");
      entityChild.setAttribute('geometry', {
        'primitive': "plane",
        'width': 3,
        'height': 1.5
      });
      entityChild.setAttribute('material', {
        'shader': "flat",
        'color': '#FB6542'
      });
      entityChild.setAttribute('visible', 'false');
      entityfield.appendChild(entityChild);

      entityChild = document.createElement('a-entity');
      entityChild.classList.add("poster-plane-image");
      entityChild.setAttribute('geometry', {
        'primitive': "plane",
        'width': 2.88,
        'height': 1.38
      });
      entityChild.setAttribute('material', {
        'shader': "flat",
        'src': '#karigurashiPoster1'
      });
      entityChild.setAttribute('position', '0 0 0.005');
      entityfield.appendChild(entityChild);


      var scene = self.el.sceneEl;
      scene.appendChild(entityfield);

    };

  </script>
</head>

<body>

    <!-- TAG Elements //// -->
    <input id="username-overlay" style="z-index: 100; bottom: 24px; left: 10px; position: fixed"
        oninput="document.getElementById('player').setAttribute('player-info', 'name', this.value)" â– />

    <!-- SCENE -->
    <a-scene environment networked-scene="room: basic-persistent; debug: true; adapter: easyrtc;">

         <!-- ASSETS -->
        <a-assets>

            <!-- rig-template -->
            <template id="rig-template">
                <a-entity></a-entity>
            </template>

            <!-- avatar-man-template -->
            <template id="avatar-man-template">
                <a-entity player-info >
                    <a-asset-item id="avatar-man" src="assets/pmariano-fullbody.glb"></a-asset-item>
                    <a-entity gltf-model="#avatar-man" rotation="0 180 0"></a-entity>
                    <a-text class="nametag" value="?" rotation="0 180 0" position="0.3 -0.20 0" side="double" scale=".6 .6 .6" color="black"></a-text>
                </a-entity>
            </template>

            <!-- box-template -->
            <template id="box-template">
                <a-entity geometry="primitive: box" material="color: red" color-changer></a-entity>
            </template>

            <!-- icon-create-template -->
            <template id="icon-create-template">
              <a-entity >
                <a-asset-item id="icon-create" src="assets/whiteboard_graph.glb"></a-asset-item>
                <a-entity gltf-model="#icon-create" rotation="0 0 0"></a-entity>     
                <a-entity text="value:CREATE; side:double ;color:#322566; shader: msdf; font:https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/berkshireswash/BerkshireSwash-Regular.json;" scale="8 8 8" position="3.1 1 0"></a-entity>
              </a-entity>
            </template>

            <!-- IMG -->
            <img id="karigurashiPoster1" src="./img/27.png" />
            <img id="karigurashiPoster2" src="./img/26.png" />
            <img id="karigurashiPoster3" src="./img/25.png" />

            <!-- poster-plane-template -->
            <template id="main-row-template">
              <a-entity >
              </a-entity>
            </template>

            <!-- poster-plane-template -->
            <template id="create-ui-template">
              <a-entity >
              </a-entity>
            </template>

            <!-- poster-plane-template -->
            <template id="create-ui-shield-template">
              <a-entity >
              </a-entity>
            </template>

        </a-assets>

        <!-- ENTITIES-->
        <a-entity id="rig" movement-controls="fly:true;" networked="template:#rig-template;" >
            <a-entity id="player" camera position="0 2 0" look-controls networked="template:#avatar-man-template;" visible="false"></a-entity>
            <a-entity cursor="rayOrigin:mouse"></a-entity>
            <a-entity laser-controls="hand: right"></a-entity>
        </a-entity>

         <!--<a-entity networked="template:#box-template;networkId:box01;" position="4 1 -4" animation="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true" ></a-entity>-->

        <a-entity>
          <a-entity geometry="primitive: cylinder; radius: 4; height: 0.3" position="0 0 -6" rotation="0 0 0" material="color: #092429" ></a-entity>
          <a-entity geometry="primitive: cylinder ; radius: 3; height: 0.2" position="0 0.2 -6" rotation="0 0 0" material="color: #24D1D3" ></a-entity>
        </a-entity>


        <a-entity networked="template:#icon-create-template;networkId:iconcreate;" scale="1.3 1.3 1.3" position="0 0.5 -6" pre-create
          animation="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true"></a-entity>



        <a-entity class="main-row" networked="template:#main-row-template;networkId:main-row-field1;" position="-3.5 6 -6" poster-events>
          <a-entity class="poster-plane" geometry="primitive: plane; width: 3; height: 1.5" material="color: #FB6542 ;shader: flat" visible="false"></a-entity>
          <a-entity class="poster-plane-image" geometry="primitive: plane; width: 2.88; height: 1.38" material="src: #karigurashiPoster1; shader: flat" position="0 0 0.005"></a-entity>
        </a-entity>

        <a-entity class="main-row" networked="template:#main-row-template;networkId:main-row-field2;" position="0 6 -6" poster-events>
          <a-entity class="poster-plane" geometry="primitive: plane; width: 3; height: 1.5" material="color: #FB6542 ;shader: flat" visible="false"></a-entity>
          <a-entity class="poster-plane-image" geometry="primitive: plane; width: 2.88; height: 1.38" material="src: #karigurashiPoster2; shader: flat" position="0 0 0.005"></a-entity>
        </a-entity>

        <a-entity class="main-row" networked="template:#main-row-template;networkId:main-row-field3;" position="3.5 6 -6" poster-events>
          <a-entity class="poster-plane" geometry="primitive: plane; width: 3; height: 1.5" material="color: #FB6542 ;shader: flat" visible="false"></a-entity>
          <a-entity class="poster-plane-image" geometry="primitive: plane; width: 2.88; height: 1.38" material="src: #karigurashiPoster3; shader: flat" position="0 0 0.005"></a-entity>
        </a-entity>



    </a-scene>
</body>

</html>